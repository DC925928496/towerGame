# 爬塔游戏 - Tower Climbing Game

## 🎯 项目概述

一个基于Web的单人回合制Roguelike爬塔游戏，目标是从第1层爬到第100层并击败最终Boss。

- **游戏类型**：回合制Roguelike爬塔
- **技术栈**：Python (WebSocket) + HTML5 Canvas + MySQL数据库
- **架构**：MVC模式，前后端分离，数据库持久化
- **设计理念**：KISS原则，简单可维护
- **数据持久化**：MySQL数据库存储，支持云端存档

---

## 🎮 核心游戏机制

### 1. 回合制战斗系统 ⚔️
- **伤害公式**：考虑武器属性的复合伤害计算
- **战斗流程**：玩家先攻击 → 怪物反击（存活时）
- **战斗奖励**：经验值 + 金币，用于升级和购买
- **特殊效果**：暴击、吸血、穿透等丰富的战斗机制

### 2. 怪物威胁区域系统 ⭐
- **威胁范围**：怪物周围3格（曼哈顿距离≤3）
- **战略限制**：威胁区域内道具/楼梯无法使用
- **战术影响**：必须先击败威胁怪物才能获得重要资源

### 3. 商人楼层系统 🆕
- **触发机制**：
  - 第1-9层：固定普通楼层
  - 第10层：固定商人楼层（保证第一次机会）
  - 第11层起：每10层20%基础概率，失败递增5%
- **交易功能**：只能购买（药水、武器、防具）
- **动态定价**：基础价格10 + 楼层×5
- **纯键盘操作**：支持完整的键盘交互，无需鼠标
- **界面优化**：宽敞清晰的交易界面，支持数字快捷键

### 4. 武器随机属性系统 ⭐ 2.0
- **六大词条类型**：
  - **攻击加成** (attack_boost)：直接提升攻击力
  - **伤害倍率** (damage_mult)：最终伤害百分比提升
  - **无视防御** (armor_pen)：忽略目标部分防御力
  - **吸血效果** (life_steal)：根据伤害回复生命值
  - **金币加成** (gold_bonus)：击败怪物获得额外金币
  - **暴击几率** (critical_chance)：攻击时造成双倍伤害
- **四档稀有度**：
  - **普通** (白色)：1个词条，无加成
  - **稀有** (蓝色)：2个词条，1.2倍数值
  - **史诗** (紫色)：3个词条，1.5倍数值
  - **传说** (金色)：4个词条，2.0倍数值
- **动态武器名称**：根据主属性自动生成（力量之剑、狂暴之刃等）
- **视觉区分**：稀有度颜色编码，界面直观显示
- **平衡设计**：基础数值平衡 + 稀有度强力，避免过度随机

### 5. 武器锻造系统 🔥
- **词条升级**：消耗金币提升词条等级，效果递增
- **成功概率**：基础90%随等级递减，稀有度提供加成
- **成本递增**：50金币基础，1.5倍指数增长
- **实时反馈**：锻造界面实时显示成功率、成本、效果
- **风险收益**：失败不降级，鼓励玩家尝试强化

### 6. 商人楼层系统 🆕
- **触发机制**：
  - 第1-9层：固定普通楼层
  - 第10层：固定商人楼层（保证第一次机会）
  - 第11层起：每10层20%基础概率，失败递增5%
- **交易功能**：只能购买（药水、武器、防具）
- **动态定价**：基础价格10 + 楼层×5
- **纯键盘操作**：支持完整的键盘交互，无需鼠标
- **界面优化**：宽敞清晰的交易界面，支持数字快捷键

### 7. 装备与道具系统
- **血瓶**：回复生命值，背包存储
- **武器/防具**：替换装备，旧装备自动掉落
- **装备掉落**：更换时旧装备落在当前位置，可重新拾取
- **词条继承**：拾取新武器时旧武器属性完全保留

### 8. 自动交互系统
- **无键操作**：移动到目标位置自动触发
- **自动拾取**：走到道具位置自动拾取（无威胁时）
- **自动上楼**：走到楼梯位置自动进入下一层（无威胁时）

### 9. 随机地图生成
- **地图规格**：15×15网格，房间+走廊布局
- **房间数量**：每层4-6个随机房间
- **难度递增**：怪物属性和道具效果随楼层指数增长

---

## 🛠️ 技术架构

### 后端架构
```
towerGame/
├── game_model.py      # 数据模型（玩家、怪物、地图、商人）
├── game_logic.py      # 游戏逻辑（战斗、交互、交易）
├── game_server.py     # WebSocket服务器和状态管理
├── map_generator.py   # 地图生成系统
├── save_load.py      # 存档系统（JSON兼容）
├── database/           # 数据库层
│   ├── connection_pool.py    # 数据库连接池
│   ├── dao/                  # 数据访问对象层
│   │   ├── base_dao.py       # DAO基类
│   │   ├── player_dao.py     # 玩家数据访问
│   │   ├── game_save_dao.py  # 存档数据访问
│   │   ├── merchant_dao.py   # 商人数据访问
│   │   └── ...               # 其他DAO类
│   └── schema.sql            # 数据库表结构
├── services/           # 业务服务层
│   ├── base_service.py       # 服务基类
│   ├── player_service.py     # 玩家服务
│   ├── game_save_service.py  # 存档服务
│   ├── merchant_service.py   # 商人服务
│   └── __init__.py           # 服务管理器
├── config/             # 配置管理
│   └── database_config.py    # 数据库配置
├── utils/              # 工具类模块
├── .env.example        # 环境变量模板
├── .env               # 环境变量配置（不提交到git）
├── requirements.txt   # 项目依赖
└── index.html         # 前端界面
```

### 数据库架构
```
MySQL数据库表结构：
├── players            # 玩家基本信息
├── weapon_attributes  # 武器属性（锻造系统）
├── game_saves         # 游戏存档
├── saved_floors       # 保存的楼层
├── floor_items        # 楼层物品
├── player_equipment   # 玩家装备
├── floor_merchants    # 楼层商人
└── merchant_inventories # 商人库存
```

### 技术特点
- **数据库持久化**：MySQL存储，支持云端存档和多设备同步
- **轻量级**：仅需`websockets`、`pymysql`、`python-dotenv`库
- **实时通信**：WebSocket双向JSON消息传递
- **模块化**：清晰的三层架构（DAO层、服务层、游戏逻辑层）
- **配置驱动**：游戏参数和数据库配置集中管理
- **连接池**：高效的数据库连接管理
- **向后兼容**：保留JSON存档支持，平滑迁移

---

## 🚀 快速开始

### 环境准备
```bash
# 安装依赖
pip install -r requirements.txt
```

### 数据库配置
```bash
# 1. 复制环境变量模板
cp .env.example .env

# 2. 编辑 .env 文件，填入数据库信息
DB_HOST=mysql.sqlpub.com
DB_PORT=3306
DB_DATABASE=ling_qian
DB_USER=your_username
DB_PASSWORD=your_password

# 3. 创建数据库表结构
mysql -h {DB_HOST} -u {DB_USER} -p{DB_PASSWORD} {DB_DATABASE} < database/schema.sql
```

### 启动服务器
```bash
cd /path/to/towerGame
python game_server.py
```
服务器将在 `ws://localhost:8080` 启动

### 开始游戏
在浏览器中打开 `index.html` 即可开始游戏

### 测试数据库连接
```bash
# 测试数据库连接和基本操作
python test_database.py

# 测试简单连接
python test_simple_connection.py
```

---

## 🎮 游戏操作

### 移动控制
- **方向键**：↑↓←→ 或 WASD
- **道具使用**：数字键 1-9 对应背包位置
- **商人交易**：按 `E` 键打开商人界面，按数字键 `1-9` 购买对应商品
- **界面关闭**：按 `ESC` 键或再次按 `E` 键关闭商人界面

### 自动交互
- **智能拾取**：走到道具位置自动拾取
- **智能上楼**：走到楼梯位置自动进入下一层
- **威胁检测**：自动检测怪物威胁，限制道具使用

---

## 📊 游戏数据系统

### 玩家属性
- **初始**：HP 500/500, 攻击力 50, 防御力 20
- **成长**：击败怪物获得经验值和金币
- **装备系统**：武器攻击力 + 防具防御力加成

### 成长公式（第N层）
- **怪物生命**：80 + N × 20 (±20%随机)
- **怪物攻击**：25 + N × 5 (±20%随机)
- **道具效果**：血瓶回复量、武器攻击力、防具防御力随楼层提升

### 商人定价机制
- **基础价格**：10 + 楼层 × 5 金币
- **商品类型**：
  - 血瓶：回复 50 + 楼层 × 20 HP
  - 武器：攻击 + 楼层 × 5
  - 防具：防御 + 楼层 × 3

---

## 🏆 游戏目标

### 胜利条件
到达第100层并击败最终Boss（死亡骑士）

### Boss属性
- **生命值**：5000
- **攻击力**：800
- **防御力**：200

### 失败条件
玩家生命值降至0（被怪物击败）

---

## 🎯 核心特色

⭐ **怪物威胁区域系统**：战术深度与策略规划
⭐ **商人楼层系统**：经济系统与装备强化
⭐ **纯键盘操作**：完整的键盘交互体验，无需鼠标操作
⭐ **自动交互系统**：流畅的游戏体验
⭐ **智能重生系统**：避免位置异常
⭐ **配置化管理**：游戏参数灵活调整
⭐ **界面优化**：宽敞清晰的交易界面，支持数字快捷键

---

## 🔧 开发与维护

### 代码规范
- 遵循KISS原则，保持代码简洁
- 完善的类型注解和函数文档
- 模块化设计，便于功能扩展

### 测试方法
```bash
# 编译测试
python -m py_compile *.py utils/*.py config/*.py
```

### 版本信息
**当前版本：v2.0**
- MySQL数据库持久化系统
- 三层架构（DAO层、服务层、游戏逻辑层）
- 连接池和事务管理
- 向后兼容JSON存档
- 配置安全管理
- 完整的测试套件

---

## 🎮 新版本亮点 (v2.0)

### MySQL数据库持久化系统 🆕
- **云端存储**：MySQL数据库存储游戏数据，支持多设备同步
- **数据安全**：环境变量配置，防止敏感信息泄露
- **连接管理**：高效连接池，自动重连和���误恢复
- **事务支持**：完整的事务管理，确保数据一致性
- **向后兼容**：保留JSON存档支持，平滑数据迁移

### 三层架构设计 🏗️
- **DAO层**：数据访问对象，统一的数据库操作接口
- **服务层**：业务逻辑封装，参数验证和错误处理
- **游戏逻辑层**：核心游戏机制，与数据层解耦

### 完整的DAO体系 📊
- **8个核心DAO类**：玩家、武器属性、存档、装备、楼层、物品、商人、库存
- **BaseDAO基类**：通用CRUD操作，统一接口
- **DAO管理器**：统一管理所有DAO实例
- **索引优化**：完善的数据库索引设计

### 服务层架构 ⚙️
- **服务基类**：通用服务功能和错误处理
- **业务封装**：玩家服务、存档服务、商人服务
- **参数验证**：完整的输入验证和数据检查
- **操作日志**：详细的业务操作记录

### 测试和工具 🧪
- **数据库测试**：完整的连接和操作测试套件
- **简单连接测试**：快速诊断连接问题
- **DAO测试**：数据访问层功能验证
- **配置验证**：环境配置检查工具

---

## 🎮 旧版本亮点 (v1.6)

### 三列对称布局系统
- **画布居中**：游戏地图位于视觉中心，成为焦点
- **左右对称**：信息面板分列两侧，布局更加平衡
- **功能分区**：左侧核心信息，右侧装备背包，信息层次清晰
- **视觉优化**：现代化三栏式设计，美观大方

### 响应式界面系统
- **多尺寸适配**：支持桌面、平板、手机等多种设备
- **动态画布**：画布尺寸根据屏幕大小自动调整（300-700px）
- **智能布局**：小屏幕自动切换为垂直布局
- **断点优化**：1400px/1200px/1000px/768px四级断点

### 界面紧凑化设计
- **字体优化**：侧边栏字体从14px调整到13px，节省空间
- **间距调整**：减少内边距和外边距，信息更密集
- **图例压缩**：图例字体11px，间距更紧凑
- **平衡布局**：侧边栏宽度调整为240px，给画布更多空间

## 🎮 旧版本亮点 (v1.5)

### 纯键盘交易系统
- **E键交互**：统一的打开/关闭商人界面，无需鼠标操作
- **数字化购买**：1-9数字键直接购买对应商品
- **快捷键提示**：界面中清晰显示每个商品的快捷键编号
- **ESC关闭支持**：提供多种关闭方式，符合用户习惯

### 界面优化增强
- **对话框扩大**：宽度从400px扩展到550px，更宽敞舒适
- **商品间距优化**：增加15px间距，信息层次更分明
- **字体尺寸增大**：14px字体，提升可读性
- **视觉效果强化**：增强阴影、圆角、边框等视觉效果
- **悬停效果**：商品项目悬停时的视觉反馈
- **禁用状态**：金币不足时按钮清晰的禁用状态

### 操作指引完善
- **图例更新**：操作说明面板添加E键交易提示
- **界面内指引**：商人界面中显示完整的键盘操作说明
- **统一操作逻辑**：商人界面与游戏状态的按键分离处理

---

## 📄 许可证

MIT License - 可自由使用、修改和分发

---

*核心特色：怪物威胁区域 + MySQL持久化 + 三层架构*
*版本：v2.0 - 数据库持久化全面升级*