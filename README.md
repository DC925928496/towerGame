# 爬塔游戏 - Tower Climbing Game

## 项目概述

一个基于Web的单人回合制Roguelike爬塔游戏，目标是从第1层爬到第100层并击败最终Boss。

- **游戏类型**：回合制Roguelike爬塔游戏
- **技术栈**：Python（后端）+ HTML5 Canvas（前端）+ WebSocket（通信）
- **架构模式**：MVC（Model-View-Controller）
- **设计理念**：KISS原则，保持简单可维护，注重代码复用性
- **核心特色**：怪物威胁区域系统、自动交互机制、渐进难度设计

---

## 🎮 核心游戏机制

### 1. 回合制战斗系统
- **伤害公式**：`伤害 = max(最小伤害值, 攻击方.atk - 防御方.def)`
- **combat flow**：玩家永远先手攻击 → 怪物反击（如存活）
- **战斗奖励**：击杀怪物获得经验值和金币，可升级提升属性

### 2. 怪物威胁区域系统 ⭐ 核心特色
- **威胁机制**：怪物周围3格内（曼哈顿距离≤3）的道具和楼梯无法拾取/使用
- **战略意义**：必须先击败威胁区域的怪物才能获得重要道具或前进
- **计算范围**：每只怪物影响25个格子（1+4+8+12），形成战略防御圈
- **游戏影响**：增加了战术规划和战斗策略的深度

### 3. 装备与道具系统
- **血瓶**：回复200点生命值，可叠加存储在背包
- **武器**：替换式装备，提供攻击加成（新装备替换旧装备）
- **防具**：替换式装备，提供防御加成
- **装备掉落**：替换装备时，旧装备自动掉落在当前位置，可重新拾取

### 4. 自动交互系统
- **无键操作**：移动到目标位置自动触发交互
- **自动拾取**：走到道具位置自动拾取（如无怪物威胁）
- **自动上楼**：走到楼梯位置自动进入下一层（如无怪物威胁）
- **流畅体验**：减少按键操作，专注策略思考

### 5. 智能重生系统 ⭐ 核心特色
- **重生保护**：玩家上楼时自动验证重生位置安全性
- **智能调整**：楼梯位置不可用时自动寻找最近可用位置
- **多层保障**：确保玩家永远不会卡在墙壁或其他障碍物中
- **位置验证**：检查通行性、边界范围和实体冲突

### 6. 地图生成冲突检测 ⭐ 核心特色
- **位置冲突避免**：防止怪物、道具、楼梯位置重叠
- **实体验证**：确保每个游戏元素放置在独立有效位置
- **生成优化**：增强地图生成算法的稳定性和可靠性
- **游戏体验**：消除位置异常导致的游戏中断

### 7. 随机地图生成
- **地图规格**：15×15网格，房间+走廊布局
- **房间数量**：每层4-6个随机房间
- **智能放置**：战略性放置怪物、道具和楼梯，确保游戏平衡性
- **层次难度**：怪物属性和道具效果随楼层增长
- **位置验证**：所有元素放置均经过有效性验证

---

## 🛠️ 技术架构

### 后端架构（Python）

```
towerGame/
├── game_model.py          # 数据模型和核心逻辑
├── game_logic.py          # 游戏交互和规则处理
├── game_server.py         # WebSocket服务器和状态管理
├── map_generator.py       # 随机地图生成系统
├── save_load.py           # 存档系统
├── utils/                 # 工具类模块
│   ├── position_utils.py  # 位置和距离计算工具
│   ├── game_utils.py      # 游戏通用工具函数
│   └── __init__.py
├── config/                # 配置管理
│   ├── game_config.py     # 游戏参数配置
│   └── __init__.py
└── index.html            # 前端游戏界面
```

**技术特点**：
- **单一依赖**：仅需`websockets`库，部署简单
- **配置化设计**：所有游戏参数集中在配置文件管理
- **工具类复用**：大量使用工具类避免代码重复
- **模块化架构**：核心逻辑、工具类、配置分离

### 前端实现（HTML5 + JavaScript）

- **Canvas 渲染**：600×600像素画布，15×15格子显示
- **实时通信**：WebSocket连接，双向JSON消息传递
- **交互设计**：键盘控制，实时状态更新，日志显示
- **无资源依赖**：使用Unicode符号，无需图片资源

### 通信协议

**客户端命令**：
```json
{"cmd": "move", "dir": "up"}           // 移动指令
{"cmd": "use_item", "item_name": "小血瓶"}  // 使用道具
```

**服务器响应**：
```json
{"type": "map", "grid": [...]}         // 地图更新
{"type": "info", "hp": 500, ...}       // 玩家状态
{"type": "log", "message": "..."}      // 游戏日志
{"type": "auto_pickup", "item": {...}} // 自动拾取
{"type": "auto_descend", "floor": 5}   // 自动下楼
{"type": "gameover", "reason": "..."}  // 游戏结束
```

---

## 🚀 快速开始

### 1. 环境准备

安装唯一的依赖包：
```bash
pip install websockets
```

### 2. 启动游戏服务器

```bash
cd E:\code\towerGame
python game_server.py
```

服务器将在 `ws://localhost:8080` 启动。

### 3. 打开游戏

在浏览器中打开 `index.html` 文件即可开始游戏。

### 4. 游戏操作

**移动控制**：
- **方向键**：↑ ↓ ← →
- **WASD键**：W A S D

**道具使用**：
- **数字键 1-9**：使用背包中对应位置的道具

**自动交互**：
- 走到道具位置 → 自动拾取（无怪物威胁时）
- 走到楼梯位置 → 自动进入下一层（无怪物威胁时）
- 走到怪物位置 → 自动进入战斗

---

## 📊 游戏数据与平衡

### 玩家初始属性
- **生命值**：500/500
- **攻击力**：50 + 武器加成
- **防御力**：20 + 防具加成
- **饥饿值**：50/100
- **初始装备**：小血瓶 ×3

### 怪物属性公式（第N层）
- **生命值**：基础值 + N × 20（±20%随机）
- **攻击力**：基础值 + N × 5（±20%随机）
- **防御力**：基础值 + N × 2（±20%随机）
- **经验值**：基础值 + N × 5
- **金币值**：基础值 + N × 3

### 道具效果公式（第N层）
- **血瓶回复**：基础值 + N × 20
- **武器攻击**：N × 5
- **防具防御**：N × 3

### 难度递增
- **怪物数量**：3 + floor // 5（每5层增加1只）
- **道具数量**：2 + floor // 8（每8层增加1个）

---

## 🏆 游戏目标

### 胜利条件
1. **到达第100层**
2. **击败最终Boss：死亡骑士**
   - 生命值：5000
   - 攻击力：800
   - 防御力：200
3. **保持生存**

### 失败条件
1. **生命值降至0**（被怪物击败）
2. **饥饿死亡**（饥饿值为0时持续掉血）

---

## ⚙️ 核心机制详解

### 怪物威胁区域算法

```python
def is_item_or_stairs_blocked_by_monster(self, target_pos):
    """检查目标位置是否被怪物威胁"""
    for monster in self.monsters.values():
        if monster.is_alive():
            # 计算曼哈顿距离
            distance = abs(monster.position.x - target_pos.x) + \
                      abs(monster.position.y - target_pos.y)
            if distance <= 3:
                return True  # 在威胁区域内
    return False
```

**威胁区域范围**：
- 距离0：1个格子（怪物位置）
- 距离1：4个格子（相邻位置）
- 距离2：8个格子（两格范围）
- 距离3：12个格子（三格边缘）
- **总计：25个格子**

### 自动交互触发条件

```python
def check_auto_interactions(player, floor):
    """移动时自动检测交互"""
    # 检查上楼
    if on_stairs and not monster_nearby:
        auto_descend()

    # 检查拾取
    elif on_item and not monster_nearby:
        auto_pickup()
```

---

## 🔧 开发与调试

### 测试编译
```bash
# 检查语法错误
python -m py_compile game_model.py game_logic.py map_generator.py game_server.py save_load.py
```

### 关键文件说明

- **`game_model.py`**：数据模型和核心逻辑
  - `is_item_or_stairs_blocked_by_monster()` - 怪物威胁检测
  - `is_valid_placement_position()` - 位置冲突验证
  - `debug_monster_threat_detection()` - 威胁调试工具
- **`game_logic.py`**：游戏规则处理
  - 自动交互系统（拾取、上楼梯）
  - 怪物威胁检测集成
- **`map_generator.py`**：随机地图生成系统
  - `find_nearest_valid_position()` - 最近安全位置查找
  - 冲突避免算法和位置验证
- **`game_server.py`**：WebSocket服务器
  - 游戏状态管理和重生逻辑
- **`utils/`**：工具类模块
  - 位置计算、游戏工具函数

### 性能特点

- **轻量级**：纯Python实现，最小外部依赖
- **实时响应**：异步WebSocket通信
- **内存友好**：单局游戏状态占用小
- **可扩展**：模块化设计便于功能扩展

---

## 🎯 设计哲学

### KISS原则体现
- **简单战斗**：无复杂暴击、闪避计算
- **直观操作**：方向键+数字键，学习成本低
- **清晰规则**：威胁区域机制易于理解
- **线性成长**：数值增长可预测

### 策略深度
- **威胁管理**：何时接近威胁区域的策略选择
- **装备规划**：装备替换时机和位置选择
- **饥饿平衡**：探索深度与生存压力的平衡
- **战斗优先级**：选择先击败哪些怪物的策略

---

## 📈 版本信息

### 当前版本：v1.3
**最新更新**：简化游戏机制，专注核心体验

#### 🔧 核心修复
- ✅ **怪物威胁区域系统**：修复"怪物距离道具太近"误判问题
- ✅ **地图生成冲突检测**：消除怪物与道具位置重叠问题
- ✅ **智能重生系统**：解决玩家上楼后卡墙问题
- ✅ **位置验证机制**：全面检查边界、通行性和实体冲突

#### 🗑️ 系统精简
- ✅ **移除饥饿值系统**：删除饥饿值和生存压力机制
- ✅ **简化移动逻辑**：无消耗移动，专注探索和战斗
- ✅ **界面优化**：移除饥饿值显示，界面更简洁
- ✅ **代码优化**：清理相关后端逻辑和数据传输

#### 🎮 游戏体验改进
- ✅ **节奏加快**：无生存压力，专注核心玩法
- ✅ **纯净体验**：聚焦爬塔、战斗、装备、道具管理
- ✅ **公平性提升**：怪物威胁规则更准确，避免误判
- ✅ **流畅性优化**：消除位置异常导致的中断
- ✅ **稳定性增强**：边界情况和异常处理更完善
- ✅ **可维护性**：代码结构更清晰，调试更便捷

#### 📊 技术优化
- ✅ **算法优化**：曼哈顿距离计算和位置搜索算法
- ✅ **内存管理**：更高效的地图生成和验证机制
- ✅ **错误处理**：完善的边界检查和异常回退
- ✅ **代码质量**：增加详细注释和类型安全检查
- ✅ 编译测试通过，确保代码稳定性

### 技术债务与限制
- **单线程服务器**：当前不支持高并发
- **无存档UI**：存档功能仅Backend实现
- **静态难度**：难度调整需要手动配置
- **无移动端适配**：仅支持桌面浏览器

---

## 🤝 贡献指南

### 代码规范
- 使用类型注解
- 函数保持单一职责
- 有意义的变量和函数命名
- 避免硬编码，使用配置文件

### 测试要求
- 编译测试确保无语法错误
- 手动测试关键游戏流程
- 验证怪物威胁机制正确性
- 检查上楼重生和地图生成
- 测试异常情况处理

---

## 📄 许可证

MIT License - 可自由使用、修改和分发

---

*最后更新：2025年11月*
*核心特色：怪物威胁区域系统 + 智能重生系统*
*版本：v1.3 - 简化游戏机制，专注核心体验*

## 📋 更新日志

### v1.3 - 2025年11月（饥饿值系统删除）
**🔧 核心精简**：
- ✅ **移除饥饿值系统**：删除饥饿值和生存压力机制
- ✅ **简化游戏循环**：移除饥饿消耗和惩罚逻辑
- ✅ **界面优化**：删除饥饿值显示，界面更简洁
- ✅ **代码清理**：清理5个文件中的饥饿相关代码
- ✅ **专注核心玩法**：爬塔、战斗、装备、道具管理

#### 🆕 新增体验特色
- ✅ **无消耗移动**：玩家可以自由移动，专注策略思考
- ✅ **纯粹体验**：专注于爬塔Roguelike核心体验
- ✅ **快速节奏**：无饥饿压力，游戏节奏更快
- ✅ **简化机制**：移除复杂状态管理

#### 📊 系统影响
- **战斗系统**：保持不变，更专注战斗策略
- **装备道具**：保持不变，更注重装备选择
- **地图探索**：保持不变，无饥饿限制
- **自动交互**：保持不变，拾取和上楼更流畅

#### 🔍 技术效果
- **代码简化**：移除大量状态管理代码
- **性能提升**：减少每回合计算开销
- **界面简洁**：删除饥饿值显示元素
- **维护性**：核心机制更清晰，更易维护

### v1.2 - 2025年11月（系统稳定性更新）
**🔧 核心修复**：
- ✅ 修复怪物威胁区域误判问题（远近不分bug）
- ✅ 消除地图生成时怪物与道具位置重叠
- ✅ 解决玩家上楼后卡在墙壁中的问题
- ✅ 完善位置验证和边界检查机制

**🆕 新增功能**：
- ✅ 智能重生系统：自动寻找安全重生位置
- ✅ 冲突避免算法：确保地图元素不重叠
- ✅ 调试工具：详细的威胁检测和位置调试
- ✅ 多层保障系统：多种回退机制

### v1.1 - 2025年11月
**🔧 核心修复**：
- ✅ 修复怪物控制机制，从道具中心检测改为怪物中心检测
- ✅ 实现真正的曼哈顿距离≤3威胁范围（25个格子）
- ✅ 优化用户体验提示，错误信息更准确

### v1.0 - 2025年11月
**初始版本**：
- ✅ 核心战斗系统、饥饿和升级机制
- ✅ 道具和装备系统、房间+走廊地图生成
- ✅ WebSocket通信和Canvas前端渲染
- ✅ 基础UI界面和自动交互系统