"""
自动生成的实体类文件
生���时间: {{ generation_time }}
工具版本: {{ tool_version }}
数据库版本: {{ database_version }}
警告: 此文件由工具自动生成，请勿手动修改！
"""

{% for import_line in imports %}
{{ import_line }}
{% endfor %}

from .base_model import BaseModel

@dataclass
class {{ class_name }}({{ base_class }}):
    """{{ class_comment }}"""

{# 分离有默认值和无默认值的字段 #}
{% set required_columns = [] %}
{% set optional_columns = [] %}
{% for column in columns %}
{% if column.default_value and column.default_value not in ['CURRENT_TIMESTAMP', 'NOW()'] or column.is_nullable or column.python_type in ['int', 'float'] %}
{% set _ = optional_columns.append(column) %}
{% else %}
{% set _ = required_columns.append(column) %}
{% endif %}
{% endfor %}

{# 无默认值的字段 #}
{% for column in required_columns %}
    {{ column.name }}: {{ column.python_type }}
{% if not loop.last %}

{% endif %}
{% endfor %}

{# 有默认值的字段 #}
{% for column in optional_columns %}
    {{ column.name }}: {{ column.python_type }}{% if column.default_value and column.default_value not in ['CURRENT_TIMESTAMP', 'NOW()'] %} = {% if column.python_type == 'str' %}"{{ column.default_value }}"{% else %}{{ column.default_value }}{% endif %}{% elif column.is_nullable %} = None{% elif column.python_type in ['int', 'float'] and not column.default_value %} = 0{% endif %}
{% if not loop.last %}

{% endif %}
{% endfor %}

{% if include_foreign_keys and foreign_keys %}
    # 外键关系
{% for fk in foreign_keys %}
    {{ fk.property_name }}: Optional['{{ fk.referenced_class }}'] = None
{% endfor %}
{% endif %}

    # 用户自定义方法保护区域
    # === USER_CUSTOM_METHODS_START ===
    # 用户可以在这里添加自定义方法，此区域不会被覆盖
    # === USER_CUSTOM_METHODS_END ===

{% if include_validation %}
    def validate(self, skip_foreign_keys: bool = False) -> List[str]:
        """
        增强的字段验证逻辑

        Args:
            skip_foreign_keys: 是否跳过外键验证

        Returns:
            验证错误列表
        """
        errors = []

        # 基本字段验证
        errors.extend(self._validate_required_fields())
        errors.extend(self._validate_field_types())
        errors.extend(self._validate_field_constraints())

        # 外键验证
        if not skip_foreign_keys:
            errors.extend(self._validate_foreign_keys())

        # 自定义业务验证
        errors.extend(self._validate_business_rules())

        return errors

    def _validate_required_fields(self) -> List[str]:
        """验证必填字段"""
        errors = []
{% for column in columns %}
{% if column.is_required and column.name != 'id' %}
        if self.{{ column.name }} is None or (isinstance(self.{{ column.name }}, str) and self.{{ column.name }}.strip() == ''):
            errors.append("{{ column.comment or column.name }}不能为空")
{% endif %}
{% endfor %}
        return errors

    def _validate_field_types(self) -> List[str]:
        """验证字段类型"""
        errors = []
{% for column in columns %}
        # {{ column.name }} 类型验证
        if self.{{ column.name }} is not None:
{% if column.python_type == 'int' %}
            if not isinstance(self.{{ column.name }}, int) or isinstance(self.{{ column.name }}, bool):
                errors.append("{{ column.comment or column.name }}必须是整数")
{% elif column.python_type == 'float' %}
            try:
                float(self.{{ column.name }})
            except (ValueError, TypeError):
                errors.append("{{ column.comment or column.name }}必须是数字")
{% elif column.python_type == 'str' %}
            if not isinstance(self.{{ column.name }}, str):
                errors.append("{{ column.comment or column.name }}必须是字符串")
{% elif column.python_type == 'datetime' %}
            if not isinstance(self.{{ column.name }}, datetime):
                errors.append("{{ column.comment or column.name }}必须是日期时间对象")
{% elif column.python_type == 'bool' %}
            if not isinstance(self.{{ column.name }}, bool):
                errors.append("{{ column.comment or column.name }}必须是布尔值")
{% endif %}
{% endfor %}
        return errors

    def _validate_field_constraints(self) -> List[str]:
        """验证字段约束"""
        errors = []
{% for column in columns %}
        # {{ column.name }} 约束验证
        if self.{{ column.name }} is not None:
{% if column.python_type in ['int', 'float'] %}
            {% if column.name.endswith('_id') %}
            # ID字段必须是正整数
            if self.{{ column.name }} <= 0:
                errors.append("{{ column.comment or column.name }}必须是正整数")
            {% else %}
            # 数值范围检查
            if self.{{ column.name }} < 0:
                errors.append("{{ column.comment or column.name }}不能为负数")
            {% endif %}
{% elif column.python_type == 'str' %}
            {% if column.max_length %}
            # 字符串长度检查
            if len(self.{{ column.name }}) > {{ column.max_length }}:
                errors.append("{{ column.comment or column.name }}长度不能超过{{ column.max_length }}个字符")
            {% endif %}
            {% if column.name.endswith('_email') %}
            # 邮箱格式验证
            import re
            email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
            if not re.match(email_pattern, self.{{ column.name }}):
                errors.append("{{ column.comment or column.name }}格式不正确")
            {% elif column.name.endswith('_phone') %}
            # 电话号码验证
            import re
            phone_pattern = r'^[\d\s\-\+\(\)]{7,20}$'
            if not re.match(phone_pattern, self.{{ column.name }}):
                errors.append("{{ column.comment or column.name }}格式不正确")
            {% elif column.name.endswith('_url') %}
            # URL格式验证
            from urllib.parse import urlparse
            try:
                result = urlparse(self.{{ column.name }})
                if not all([result.scheme, result.netloc]):
                    errors.append("{{ column.comment or column.name }}格式不正确")
            except Exception:
                errors.append("{{ column.comment or column.name }}格式不正确")
            {% endif %}
{% elif column.python_type == 'datetime' %}
            # datetime类型不需要长度验证
            pass
{% endif %}
{% if column.is_unique and not column.is_primary_key %}
            # 唯一性验证提示
            # 注意：这里只做格式检查，实际唯一性检查需要在数据库层面
            pass  # 在DAO层实现唯一性检查
{% endif %}
        {% endfor %}
        return errors

    def _validate_foreign_keys(self) -> List[str]:
        """验证外键关系"""
        errors = []
{% if foreign_keys %}
{% for fk in foreign_keys %}
        # {{ fk.property_name }} 外键验证
        if self.{{ fk.column }} is not None:
            if self.{{ fk.column }} <= 0:
                errors.append("{{ fk.property_name }}的ID必须是有效正整数")
            if self.{{ fk.property_name }} is None:
                errors.append("{{ fk.property_name }}对象不存在")
{% endfor %}
{% endif %}
        return errors

    def _validate_business_rules(self) -> List[str]:
        """自定义业务规则验证"""
        errors = []
        # 子类可以重写此方法添加自定义业务验证逻辑

        # 通用业务规则示例：
{% for column in columns %}
{% if column.name == 'email' %}
        # 邮箱小写化
        if self.email and hasattr(self.email, 'lower'):
            self.email = self.email.lower()
{% elif column.name == 'username' %}
        # 用户名格式检查
        if self.username:
            import re
            if not re.match(r'^[a-zA-Z0-9_]{3,20}$', self.username):
                errors.append("用户名只能包含字母、数字和下划线，长度3-20位")
{% elif column.name == 'password' %}
        # 密码强度检查
        if self.password:
            if len(self.password) < 6:
                errors.append("密码长度至少6位")
{% endif %}
{% endfor %}

        return errors

    def is_valid(self, skip_foreign_keys: bool = False) -> bool:
        """
        快速验证方法

        Args:
            skip_foreign_keys: 是否跳过外键验证

        Returns:
            是否验证通过
        """
        return len(self.validate(skip_foreign_keys=skip_foreign_keys)) == 0

    def get_validation_summary(self) -> Dict[str, Any]:
        """
        获取验证摘要信息

        Returns:
            包含验证结果详细信息的字典
        """
        errors = self.validate()
        return {
            'valid': len(errors) == 0,
            'error_count': len(errors),
            'errors': errors,
            'field_count': {{ columns|length }},
            'required_fields': [{% for column in columns %}{% if column.is_required and column.name != 'id' %}'{{ column.name }}',{% endif %}{% endfor %}],
            'foreign_keys': [{% for fk in foreign_keys %}'{{ fk.property_name }}',{% endfor %}]
        }
{% endif %}

    def to_dict(self, exclude_none: bool = False) -> Dict[str, Any]:
        """
        转换为字典

        Args:
            exclude_none: 是否排除None值

        Returns:
            字典表示
        """
        result = {k: v for k, v in self.__dict__.items() if not k.startswith('_')}

        if exclude_none:
            result = {k: v for k, v in result.items() if v is not None}

        return result

    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> '{{ class_name }}':
        """
        从字典创建实例

        Args:
            data: 字典数据

        Returns:
            实例对象
        """
        # 过滤掉不存在的字段
        valid_fields = {f.name for f in cls.__dataclass_fields__.values()}
        filtered_data = {k: v for k, v in data.items() if k in valid_fields}

        return cls(**filtered_data)

    def __post_init__(self):
        """初始化后处理"""
        # 数据清理和标准化
        self._clean_data()

        # 基本验证（可选）
        # if not self.is_valid():
        #     raise ValueError("Invalid data detected in __post_init__")

    def _clean_data(self):
        """数据清理和标准化"""
{% for column in columns %}
        # {{ column.name }} 数据清理
{% if column.python_type == 'str' %}
        if self.{{ column.name }}:
            # 去除首尾空格
            self.{{ column.name }} = self.{{ column.name }}.strip()
            {% if column.name in ['email', 'username'] %}
            # 转换为小写
            self.{{ column.name }} = self.{{ column.name }}.lower()
            {% endif %}
{% elif column.python_type in ['int', 'float'] %}
        if self.{{ column.name }} is not None:
            try:
                self.{{ column.name }} = {{ 'int' if column.python_type == 'int' else 'float' }}(self.{{ column.name }})
            except (ValueError, TypeError):
                pass  # 保持原值，在validate中会报错
{% endif %}
{% endfor %}